<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Cliente</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h2>Cadastro de Cliente</h2>

    <div id="successMessage" class="alert alert-success" style="display:none;">
        Cadastro finalizado com sucesso! Redirecionando para o login...
    </div>

    <div id="errorMessage" class="alert alert-danger" style="display:none;"></div>

    <form id="cadastroForm" action="/cliente/cadastro" method="post">
        <div class="mb-3">
            <label for="nomeCompleto">Nome Completo</label>
            <input type="text" id="nomeCompleto" name="nomeCompleto" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="dataNascimento">Data de Nascimento</label>
            <input type="date" id="dataNascimento" name="dataNascimento" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="genero">Gênero</label>
            <select id="genero" name="genero" class="form-control" required>
                <option value="">Selecione</option>
                <option value="Masculino">Masculino</option>
                <option value="Feminino">Feminino</option>
                <option value="Outro">Outro</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="cpf">CPF</label>
            <input type="text" id="cpf" name="cpf" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="senha">Senha</label>
            <input type="password" id="senha" name="senha" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="cep">CEP</label>
            <input type="text" id="cep" name="cep" class="form-control" required onblur="buscarEndereco()">
        </div>
        <div class="mb-3">
            <label for="logradouro">Endereço</label>
            <input type="text" id="logradouro" name="enderecoFaturamento" class="form-control" placeholder="Endereço" required readonly>
        </div>
        <div class="mb-3">
            <label for="numero">Número</label>
            <input type="text" id="numero" name="numero" class="form-control" placeholder="Número" required>
        </div>
        <div class="mb-3">
            <label for="complemento">Complemento</label>
            <input type="text" id="complemento" name="complemento" class="form-control" placeholder="Complemento">
        </div>
        <div class="mb-3">
            <label for="bairro">Bairro</label>
            <input type="text" id="bairro" name="bairro" class="form-control" placeholder="Bairro" required readonly>
        </div>
        <div class="mb-3">
            <label for="cidade">Cidade</label>
            <input type="text" id="cidade" name="cidade" class="form-control" placeholder="Cidade" required readonly>
        </div>
        <div class="mb-3">
            <label for="uf">UF</label>
            <input type="text" id="uf" name="uf" class="form-control" placeholder="UF" required readonly>
        </div>
        <div class="mb-3">
            <h4>Endereços de Entrega (obrigatório, pode adicionar até 3)</h4>
            <div id="enderecosEntrega"></div>
            <button type="button" id="adicionarEndereco" class="btn btn-success mt-2">Adicionar Endereço de Entrega</button>
            <button type="button" id="copiarEndereco" class="btn btn-secondary mt-2">Copiar Endereço de Faturamento</button>
        </div>
        <button type="submit" class="btn btn-primary">Cadastrar</button>
    </form>
</div>

<script>
    let contadorEnderecos = 0;

    $("#cadastroForm").submit(function(event) {
        event.preventDefault(); // Prevent default form submission

        $.ajax({
            type: $(this).attr('method'),
            url: $(this).attr('action'),
            data: $(this).serialize(),
            success: function(response) {
                // Armazenar mensagem no localStorage
                localStorage.setItem("mensagemCadastro", "Cadastro realizado com sucesso!");

                $("#successMessage").show();
                setTimeout(function() {
                    window.location.href = "/login"; // Redirect to login page
                }, 2000); // Redirect after 2 seconds
            },
            error: function(jqXHR) {
                const errorMsg = jqXHR.responseJSON && jqXHR.responseJSON.message
                    ? jqXHR.responseJSON.message
                    : "Erro ao cadastrar. Tente novamente.";
                $("#errorMessage").text(errorMsg).show(); // Display the error message on the page
            }
        });
    });

    $("#adicionarEndereco").click(function() {
        if (contadorEnderecos >= 3) {
            alert("Você pode adicionar no máximo 3 endereços de entrega.");
            return;
        }

        const logradouro = $("#logradouro").val();
        const numero = $("#numero").val();
        const complemento = $("#complemento").val();
        const bairro = $("#bairro").val();
        const cidade = $("#cidade").val();
        const uf = $("#uf").val();
        const cep = $("#cep").val();

        if (!logradouro || !numero || !bairro || !cidade || !uf || !cep) {
            alert("Por favor, preencha o endereço de faturamento antes de adicioná-lo.");
            return;
        }

        contadorEnderecos++;
        const novoEndereco = `
            <div class="endereco-item mb-3" id="endereco-${contadorEnderecos}">
                <h5>Endereço de Entrega ${contadorEnderecos}</h5>
                <label for="cepEntrega">CEP</label>
                <input type="text" class="form-control" name="enderecoEntrega[${contadorEnderecos}].cep" value="${cep}" required>
                <label for="logradouroEntrega">Logradouro</label>
                <input type="text" class="form-control" name="enderecoEntrega[${contadorEnderecos}].logradouro" value="${logradouro}" required>
                <label for="numeroEntrega">Número</label>
                <input type="text" class="form-control" name="enderecoEntrega[${contadorEnderecos}].numero" value="${numero}" required>
                <label for="complementoEntrega">Complemento</label>
                <input type="text" class="form-control" name="enderecoEntrega[${contadorEnderecos}].complemento" value="${complemento}">
                <label for="bairroEntrega">Bairro</label>
                <input type="text" class="form-control" name="enderecoEntrega[${contadorEnderecos}].bairro" value="${bairro}" required>
                <label for="cidadeEntrega">Cidade</label>
                <input type="text" class="form-control" name="enderecoEntrega[${contadorEnderecos}].cidade" value="${cidade}" required>
                <label for="ufEntrega">UF</label>
                <input type="text" class="form-control" name="enderecoEntrega[${contadorEnderecos}].uf" value="${uf}" required>
                <button type="button" class="btn btn-danger mt-2" onclick="removerEndereco(${contadorEnderecos})">Remover Endereço</button>
            </div>
        `;
        $("#enderecosEntrega").append(novoEndereco);
    });

    $("#copiarEndereco").click(function() {
        if (contadorEnderecos >= 3) {
            alert("Você pode adicionar no máximo 3 endereços de entrega.");
            return;
        }

        const logradouro = $("#logradouro").val();
        const numero = $("#numero").val();
        const complemento = $("#complemento").val();
        const bairro = $("#bairro").val();
        const cidade = $("#cidade").val();
        const uf = $("#uf").val();
        const cep = $("#cep").val();

        if (!logradouro || !numero || !bairro || !cidade || !uf || !cep) {
            alert("Por favor, preencha o endereço de faturamento antes de copiá-lo.");
            return;
        }

        contadorEnderecos++;
        const novoEndereco = `
            <div class="endereco-item mb-3" id="endereco-${contadorEnderecos}">
                <h5>Endereço de Entrega ${contadorEnderecos}</h5>
                <label for="cepEntrega">CEP</label>
                <input type="text" class="form-control" name="enderecoEntrega[${contadorEnderecos}].cep" value="${cep}" required>
                <label for="logradouroEntrega">Logradouro</label>
                <input type="text" class="form-control" name="enderecoEntrega[${contadorEnderecos}].logradouro" value="${logradouro}" required>
                <label for="numeroEntrega">Número</label>
                <input type="text" class="form-control" name="enderecoEntrega[${contadorEnderecos}].numero" value="${numero}" required>
                <label for="complementoEntrega">Complemento</label>
                <input type="text" class="form-control" name="enderecoEntrega[${contadorEnderecos}].complemento" value="${complemento}">
                <label for="bairroEntrega">Bairro</label>
                <input type="text" class="form-control" name="enderecoEntrega[${contadorEnderecos}].bairro" value="${bairro}" required>
                <label for="cidadeEntrega">Cidade</label>
                <input type="text" class="form-control" name="enderecoEntrega[${contadorEnderecos}].cidade" value="${cidade}" required>
                <label for="ufEntrega">UF</label>
                <input type="text" class="form-control" name="enderecoEntrega[${contadorEnderecos}].uf" value="${uf}" required>
                <button type="button" class="btn btn-danger mt-2" onclick="removerEndereco(${contadorEnderecos})">Remover Endereço</button>
            </div>
        `;
        $("#enderecosEntrega").append(novoEndereco);
    });

    function buscarEndereco() {
        const cep = $("#cep").val().replace(/\D/g, '');

        if (cep.length === 8) {
            $.getJSON(`https://viacep.com.br/ws/${cep}/json/?callback=?`, function(data) {
                if (!("erro" in data)) {
                    $("#logradouro").val(data.logradouro);
                    $("#bairro").val(data.bairro);
                    $("#cidade").val(data.localidade);
                    $("#uf").val(data.uf);
                } else {
                    alert("CEP não encontrado.");
                }
            });
        } else {
            alert("Formato de CEP inválido.");
        }
    }

    function removerEndereco(id) {
        $("#endereco-" + id).remove();
        contadorEnderecos--;
    }
</script>
</body>
</html>
